
import express from "express";
import fetch from "node-fetch";
import bodyParser from "body-parser";
import dotenv from "dotenv";
import { logUnanswered, isUnrecognizedResponse } from "./log_unanswered.js";
import { faq } from "./faq.js";
dotenv.config();

const app = express();
app.use(bodyParser.json());

const PORT = process.env.PORT || 10000;
const USEDESK_API_TOKEN = process.env.USEDESK_API_TOKEN;
const USEDESK_USER_ID = process.env.USEDESK_USER_ID;
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const CLIENT_ID_LIMITED = "175888649";

const systemPrompt = `
Ð¢Ñ‹ â€” Ð°Ð³ÐµÐ½Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð¹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ ÑÐµÑ€Ð²Ð¸ÑÐ° Payda Ð­Ð”Ðž. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð»Ð°ÐºÐ¾Ð½Ð¸Ñ‡Ð½Ð¾, Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ Ð¸ Ð¿Ð¾ Ð´ÐµÐ»Ñƒ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹, Ð½Ð¾ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ. ÐžÑÐ½Ð¾Ð²Ñ‹Ð²Ð°Ð¹ÑÑ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ… Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ñ…:

1. Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾ÑÑ‚ ÑƒÑÐ»ÑƒÐ³Ð¸? â€” Ð£ÑÐ»ÑƒÐ³Ð¸ ÑÑ‚Ð¾ÑÑ‚ 500 Ñ‚Ð³ Ð² Ð¼ÐµÑÑÑ†.
2. ÐšÐ°Ðº ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°? â€” ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¯Ð½Ð´ÐµÐºÑÐŸÑ€Ð¾: Â«Ð¥Ð¾Ñ‡Ñƒ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Payda Ð­Ð”ÐžÂ» Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð˜Ð˜Ð.
3. Ð“Ð´Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ https://taxi.edo.kz/.
4. ÐšÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÑƒÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ Ñ 8 Ð¿Ð¾ 15 Ñ‡Ð¸ÑÐ»Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼ÐµÑÑÑ†Ð°.
5. Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ, ÐµÑÐ»Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸? â€” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð»Ð¸ Ð²Ñ‹ Ð½Ð°Ñ Ð² Ð¯Ð½Ð´ÐµÐºÑÐŸÑ€Ð¾ Ð¸ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð»Ð¸ Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ.
6. ÐšÐ°Ðº Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, ÐºÑ‚Ð¾ Ð¼Ð¾Ð¹ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€? â€” ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¯Ð½Ð´ÐµÐºÑÐŸÑ€Ð¾.
7. ÐšÐ¾Ð³Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸? â€” Ð’ Ð»ÑŽÐ±Ð¾Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚, Ð½Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ 8 Ñ‡Ð¸ÑÐ»Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¼ÐµÑÑÑ†Ð°.
8. ÐÑƒÐ¶Ð½Ð¾ Ð»Ð¸ Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð·Ð°Ñ€Ð°Ð½ÐµÐµ? â€” ÐÐµÑ‚, ÐºÐ½Ð¾Ð¿ÐºÐ° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð².
9. Ð“Ð´Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ? â€” ÐœÑ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ð¼ ÑÐ¼Ñ Ð½Ð° Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°.
10. Ð§Ñ‚Ð¾, ÐµÑÐ»Ð¸ Ð½Ðµ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ ÑÐ¼Ñ? â€” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Payda.
11. ÐšÐ°Ðº ÑƒÐ·Ð½Ð°Ñ‚ÑŒ, Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð»Ð¸ Ð¼Ð¾Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” Ð—Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ°Ð¹Ñ‚ https://taxi.edo.kz/ Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐ¹Ñ‚ÐµÑÑŒ.
12. ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Kaspi Ð´Ð»Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹? â€” Ð”Ð°, ÐºÐ½Ð¾Ð¿ÐºÐ° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Kaspi Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ.
13. ÐšÐ°ÐºÐ¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒ? â€” ÐÐ’Ð  Ð¸ Ð­Ð¡Ð¤, ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¼ÐµÑÑÑ†.
14. Ð ÐµÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ñ‹ Ñ Ð¯Ð½Ð´ÐµÐºÑÐ¾Ð¼, Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒ.
15. Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´? â€” ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ 1-2 Ð´Ð½Ñ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð° Ð² Ð¯Ð½Ð´ÐµÐºÑÐŸÑ€Ð¾.
16. ÐšÑ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ð¹ Payda? â€” ÐœÑ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€ ÑÐ»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ð°.
17. Ð§ÐµÐ¼ Ð²Ñ‹ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÐµÑÑŒ Ð¾Ñ‚ Ð´Ñ€ÑƒÐ³Ð¸Ñ…? â€” Ð£ Ð½Ð°Ñ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¹ ÑÐ°Ð¹Ñ‚, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¸ Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð².
18. Ð¯ Ñ€Ð°Ð½ÑŒÑˆÐµ Ð±Ñ‹Ð» Ñƒ Ð‘ÑƒÑ…Ñ‚Ñ‹, ÐºÐ°Ðº Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸? â€” ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¯Ð½Ð´ÐµÐºÑÐŸÑ€Ð¾ Ð¾ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ðµ Ð½Ð° Payda Ð­Ð”Ðž, ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð˜Ð˜Ð Ð¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ. Ð¡ 8 Ñ‡Ð¸ÑÐ»Ð° Ð²Ñ‹ Ñƒ Ð½Ð°Ñ.
19. ÐšÐ¾Ð³Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” Ð¡ 8 Ð¿Ð¾ 15 Ñ‡Ð¸ÑÐ»Ð¾, ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¼ÐµÑÑÑ†.
20. Ð“Ð´Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” ÐŸÐ¾ÑÐ»Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ https://taxi.edo.kz/.
21. Ð Ð³Ð´Ðµ Ñ Ð¼Ð¾Ð³Ñƒ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ? â€” Ð’ ÑÑ‚Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ Ð¸Ð»Ð¸ Ð¿Ð¾ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°Ð¼ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸.
22. Ð£ Ð¼ÐµÐ½Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ â€” ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ, Ð¼Ñ‹ Ñ€ÐµÑˆÐ¸Ð¼ Ð²ÑÑ‘.
23. ÐÐµ Ð²Ð¸Ð¶Ñƒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ â€” ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿Ð¾ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ.
24. ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ñ Ð½Ðµ Ð²Ð¸Ð¶Ñƒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð»Ð¸ Ð½Ð°Ñ Ð² Ð¯Ð½Ð´ÐµÐºÑÐŸÑ€Ð¾ Ð¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ Ð»Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ.
25. Ð¯ Ð²Ñ‹Ð±Ñ€Ð°Ð» Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°, Ñ‡Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ? â€” Ð–Ð´Ð¸Ñ‚Ðµ ÑÐ¼Ñ Ð¾Ñ‚ Ð½Ð°Ñ Ñ 8 Ñ‡Ð¸ÑÐ»Ð°.
26. Ð¯ ÑƒÐ¶Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ â€” ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð–Ð´Ð¸Ñ‚Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ñ 8 Ñ‡Ð¸ÑÐ»Ð°.
27. Ð“Ð´Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ? â€” ÐÐ° ÑÐ°Ð¹Ñ‚Ðµ https://payda.usedocs.com Ð¸Ð»Ð¸ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚Ðµ Ð² Ñ‡Ð°Ñ‚Ðµ.
28. ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² ÑÐµÑ€ÐµÐ´Ð¸Ð½Ðµ Ð¼ÐµÑÑÑ†Ð°? â€” Ð”Ð°, Ð½Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ñ 8 Ñ‡Ð¸ÑÐ»Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¼ÐµÑÑÑ†Ð°.
29. Ð¯ Ð½Ðµ ÑƒÑÐ¿ÐµÐ» Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð¼ Ð¼ÐµÑÑÑ†Ðµ â€” ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ, Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ.
30. ÐšÑ‚Ð¾ Ð²Ð¸Ð´Ð¸Ñ‚ Ð¼Ð¾Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹? â€” Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ‹ Ð¸ Ð²Ð°Ñˆ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€.

Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» Ð½ÑƒÐ¶Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð² ÑÑ‚Ð¾Ð¼ ÑÐ¿Ð¸ÑÐºÐµ â€” Ð¿Ð¾ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ñ…Ð¾Ð¶Ð¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð² Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð±Ð°Ð·Ðµ Ð½Ð¸Ð¶Ðµ.
`;

function buildExtendedPrompt(faq, userMessage) {
  let block = \`Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð±Ð°Ð·Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:\n`;
  faq.forEach((item, i) => {
    block += \`\${i + 1}. Ð’Ð¾Ð¿Ñ€Ð¾Ñ: \${item.question}\nÐžÑ‚Ð²ÐµÑ‚: \${item.answer}\n\n`;
    if (item.aliases && item.aliases.length > 0) {
      item.aliases.forEach(alias => {
        block += \`ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ: \${alias}\nÐžÑ‚Ð²ÐµÑ‚: \${item.answer}\n\n`;
      });
    }
  });
  block += \`Ð•ÑÐ»Ð¸ Ð¸ ÑÑ€ÐµÐ´Ð¸ ÑÑ‚Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð½ÐµÑ‚ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ â€” Ñ‡ÐµÑÑ‚Ð½Ð¾ ÑÐºÐ°Ð¶Ð¸, Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð·Ð½Ð°ÐµÑˆÑŒ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒÑÑ Ðº Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ.\n\nÐ’Ð¾Ð¿Ñ€Ð¾Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: "\${userMessage}"\nÐžÑ‚Ð²ÐµÑ‚:`;
  return block;
}

app.post("/", async (req, res) => {
  const data = req.body;
  if (!data || !data.text || data.from !== "client") return res.sendStatus(200);
  if (data.client_id != CLIENT_ID_LIMITED) return res.sendStatus(200);

  const chat_id = data.chat_id;
  const message = data.text;
  console.log("ðŸš€ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:", message);

  const fullPrompt = \`\${systemPrompt}\n\n\${buildExtendedPrompt(faq, message)}`;

  let aiAnswer = "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð½Ðµ ÑÐ¼Ð¾Ð³ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ ðŸ˜…";

  try {
    const geminiRes = await fetch(
      \`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=\${GEMINI_API_KEY}\`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            { role: "user", parts: [{ text: fullPrompt }] }
          ]
        })
      }
    );

    const geminiData = await geminiRes.json();
    aiAnswer = geminiData.candidates?.[0]?.content?.parts?.[0]?.text || aiAnswer;
    console.log("ðŸ¤– ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ Gemini:", aiAnswer);

    if (isUnrecognizedResponse(aiAnswer)) {
      console.log("ðŸ“Œ ÐžÑ‚Ð²ÐµÑ‚ Ð½Ðµ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð½ â€” Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼.");
      logUnanswered(message, data.client_id);
    }

  } catch (err) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Gemini:", err);
  }

  try {
    const usedeskRes = await fetch("https://api.usedesk.ru/chat/sendMessage", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        api_token: USEDESK_API_TOKEN,
        chat_id,
        user_id: USEDESK_USER_ID,
        text: aiAnswer
      })
    });

    const usedeskData = await usedeskRes.json();
    console.log("âœ… ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ:", usedeskData);
  } catch (err) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² Usedesk:", err);
  }

  res.sendStatus(200);
});

app.listen(PORT, () => {
  console.log(\`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ \${PORT}\`);
});
